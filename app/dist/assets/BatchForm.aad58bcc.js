import{A as S,B as pe,u as he,r as f,q as x,o as fe,s as ye,a as z,b as i,e as a,g as L,d as e,w as ge,D as c,J as N,n as w,m as d,h as u,E as y,F as p,f as g,t as h,G as J}from"./index.0a935b94.js";import{r as C,b as F,d as ke,u as P,f as H}from"./index.7ebf2a24.js";import{h as W}from"./toast.cd5fee6e.js";import{_ as we}from"./Loader.232eaff5.js";import{f as Ce}from"./formatters.fd94289a.js";class $e extends S{constructor(){super("/batches")}async execMoviment(R,B){try{return(await this.api.post(`${this.path}/${R}/moviment`,B)).data}catch($){return $.response}}}const Ae={class:"content"},Ve={class:"row"},Ne={class:"mb-3 col-6"},Se=e("label",{class:"form-label"},"Nome",-1),De=["disabled"],Me={key:0,class:"invalid-feedback"},Ue={class:"mb-3 col-6"},qe=e("label",{class:"form-label"},"Status",-1),Re=e("option",{value:!0},"Ativo",-1),Be=e("option",{value:!1},"Inativo",-1),Ee=[Re,Be],Oe={class:"mb-3"},Te=e("label",{class:"form-label"},"Descri\xE7\xE3o",-1),xe=["disabled"],Le={class:"mb-3 col-6"},Fe=e("label",{class:"form-label"},"Galp\xE3o",-1),Ie=["disabled"],Ke=e("option",{value:""},"Selecione",-1),je=["value"],Ge={key:0,class:"invalid-feedback"},Qe={class:"mb-3 col-6"},ze=e("label",{class:"form-label"},"Sala",-1),Je={key:0},Pe=["value"],He=["disabled"],We=e("option",{value:""},"Selecione",-1),Xe=["value"],Ye={key:2,class:"invalid-feedback"},Ze={class:"mb-3 col-6"},es=e("label",{class:"form-label"},"Curva de Alimenta\xE7\xE3o",-1),ss=e("option",{value:""},"Selecione",-1),ts=["value"],is={key:0,class:"invalid-feedback"},as={class:"mb-3 col-6"},ls=e("label",{class:"form-label"},"Dia Inicial",-1),os=["disabled"],ns=e("option",{value:""},"Selecione",-1),ds=["value"],cs={key:0,class:"invalid-feedback"},us={class:"d-flex justify-content-between align-items-center mb-2"},rs=e("h5",{class:"m-0"},"Movimentos",-1),_s={key:0,class:"mb-3"},vs=e("div",{class:"row mb-3"},[e("div",{class:"col-2"},[e("strong",null,"Tipo Movimento")]),e("div",{class:"col-2"},[e("strong",null,"Baia Origem")]),e("div",{class:"col-2"},[e("strong",null,"Baia Destino")]),e("div",{class:"col-1"},[e("strong",null,"Qnt")]),e("div",{class:"col-2"},[e("strong",null,"Descri\xE7\xE3o")]),e("div",{class:"col-3"},[e("strong",null,"Data")])],-1),ms={class:"col-2"},bs=["onUpdate:modelValue","disabled"],ps=e("option",{value:""},"Selecione o tipo",-1),hs=["value"],fs={class:"col-2"},ys=["onUpdate:modelValue","disabled"],gs=e("option",{value:""},"Origem",-1),ks=["value"],ws={class:"col-2"},Cs=["onUpdate:modelValue","disabled"],$s=e("option",{value:""},"Destino",-1),As=["value"],Vs={class:"col-1"},Ns=["onUpdate:modelValue","disabled"],Ss={class:"col-2"},Ds=["onUpdate:modelValue","disabled"],Ms={key:0,class:"col-2 col-md-3"},Us=["value"],qs=["disabled"],Rs={key:0,class:"spinner-border spinner-border-sm me-2"},Bs={key:0,class:"modal fade show d-block",tabindex:"-1"},Es={class:"modal-dialog modal-dialog-centered"},Os={class:"modal-content"},Ts={class:"modal-header"},xs=e("h5",{class:"modal-title"},"Novo Movimento",-1),Ls={class:"modal-body"},Fs={class:"mb-3"},Is=e("label",null,"Tipo de Movimento",-1),Ks=e("option",{value:""},"Selecione",-1),js=["value"],Gs={key:0,class:"invalid-feedback"},Qs={key:0,class:"mb-3"},zs=e("label",null,"Baia Origem",-1),Js=e("option",{value:""},"Selecione",-1),Ps=["value"],Hs={key:0,class:"invalid-feedback"},Ws={key:1,class:"mb-3"},Xs=e("label",null,"Baia Destino",-1),Ys=e("option",{value:""},"Selecione",-1),Zs=["value"],et={key:0,class:"invalid-feedback"},st={class:"mb-3"},tt=e("label",null,"Quantidade",-1),it={key:0,class:"invalid-feedback"},at={class:"mb-3"},lt=e("label",null,"Descri\xE7\xE3o (opcional)",-1),ot={class:"modal-footer"},nt={key:1,class:"modal-backdrop fade show"},vt={__name:"BatchForm",setup(X){const R=pe(),B=he(),$=new $e,Y=new S("/sheds"),Z=new S("/feeding-curves"),ee=new S("/moviment-kinds"),se=new S("/baias"),te=new S("/salas"),r=f(null),I=f([]),K=f([]),E=f([]),O=f([]),D=f([]),l=x({name:"",description:"",initial_day:null,is_active:!0,feeding_curve_id:null,shed_id:null,sala_id:null,moviments:[],sala:{}}),T=async()=>{const o=await $.get(r.value);Object.assign(l,o.data),l.shed_id&&await j(l.shed_id),l.feeding_curve_id&&await G(l.feeding_curve_id),l.sala_id&&await fetchStallOptions(l.sala_id)},ie=async()=>{const o=await Y.getList();I.value=o.data.items.map(t=>({label:t.name,value:t.id,rooms:t.rooms}))||[]},j=async o=>{const t=await te.getList({shed_id:o,is_in_batch:!1});K.value=t.data.items.map(m=>({label:m.name,value:m.id}))||[]},ae=async()=>{const o=await Z.getList();E.value=o.data.items.map(t=>({label:t.name,value:t.id,details:t.details}))||[]},G=async o=>{var m;const t=E.value.find(U=>U.value===o);t&&(O.value=((m=t.details)==null?void 0:m.map(U=>U.age_day))||[])},le=async()=>{const o=await ee.getList();D.value=o.data.items.map(t=>({label:t.code,value:t.id,kind:t.kind}))||[]},oe=async()=>{!l.sala_id||(await ne(l.sala_id),r.value||de())},A=f([]),ne=async o=>{if(!o)return;const t=await se.getList({sala_id:o});A.value=t.data.items.map(m=>({label:m.name,value:m.id,qnt:m.animals_quantity}))||[]},de=()=>{l.moviments=A.value.map(o=>{var t;return{moviment_kind_code:"ENTRADA_LOTE",moviment_kind_id:((t=D.value.find(m=>m.label==="ENTRADA_LOTE"))==null?void 0:t.value)||null,stall_origin_id:o.value,stall_destination_id:null,quantity:0,description:"",isNew:!0}})},_=x({moviment_kind_:{},stall_origin_id:null,stall_destination_id:null,quantity:null,description:""});fe(async()=>{r.value=B.params.id,await Promise.all([ie(),ae(),le(),fetchStallOptions()]),r.value&&await T()});const ce=x({name:{required:C},description:{},is_active:{required:C},initial_day:{required:C,minValue:F(1)},feeding_curve_id:{required:C},shed_id:{required:C},sala_id:{required:C},moviments:{$each:ke.forEach({quantity:{required:C,minValue:F(0)}})}}),v=P(ce,l),b=f(!1),q=f(!1),ue=async o=>{W(o,"Lote salvo com sucesso"),o.success&&(r.value||(R.push({name:"batch-form",params:{id:o.data.id}}),r.value=o.data.id),await T())},re=async()=>{if(v.value.$touch(),b.value=!0,!v.value.$invalid){q.value=!0;try{const o=r.value?await $.update(r.value,l):await $.save(l);await ue(o)}finally{q.value=!1}}},_e=ye(()=>({moviment_kind_id:{required:C},stall_origin_id:{required:H(()=>["ENTRADA","TRANSFERENCIA"].includes(M.value))},stall_destination_id:{required:H(()=>["SAIDA","TRANSFERENCIA"].includes(M.value))},quantity:{required:C,minValue:F(1)}})),k=P(_e,_),V=f(!1),ve=()=>{Object.assign(_,{moviment_kind_id:null,stall_origin_id:null,stall_destination_id:null,quantity:null,description:""}),V.value=!0},M=f(null),me=()=>{const o=D.value.find(t=>t.value===_.moviment_kind_id);M.value=o?o.kind:null},be=async()=>{if(k.value.$touch(),k.value.$invalid)return;const o=await $.execMoviment(r.value,_);W(o,"Movimento registrado com sucesso"),o.success&&(V.value=!1,await T())};return(o,t)=>{const m=z("mdicon"),U=z("BaseBlock");return i(),a(p,null,[L(we,{ref:"loader"},null,512),e("div",Ae,[L(U,{title:"Lote"},{default:ge(()=>[e("div",Ve,[e("div",Ne,[Se,c(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l.name=s),type:"text",class:w(["form-control",{"is-invalid":d(v).name.$error&&b.value}]),disabled:r.value},null,10,De),[[N,l.name]]),d(v).name.$error&&b.value?(i(),a("div",Me," Campo obrigat\xF3rio ")):u("",!0)]),e("div",Ue,[qe,c(e("select",{"onUpdate:modelValue":t[1]||(t[1]=s=>l.is_active=s),class:"form-select"},Ee,512),[[y,l.is_active]])]),e("div",Oe,[Te,c(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>l.description=s),type:"text",class:"form-control",disabled:r.value},null,8,xe),[[N,l.description]])]),e("div",Le,[Fe,c(e("select",{"onUpdate:modelValue":t[3]||(t[3]=s=>l.shed_id=s),class:w(["form-select",{"is-invalid":d(v).shed_id.$error&&b.value}]),onChange:t[4]||(t[4]=s=>j(l.shed_id)),disabled:r.value},[Ke,(i(!0),a(p,null,g(I.value,s=>(i(),a("option",{key:s.value,value:s.value},h(s.label),9,je))),128))],42,Ie),[[y,l.shed_id]]),d(v).shed_id.$error&&b.value?(i(),a("div",Ge," Campo obrigat\xF3rio ")):u("",!0)]),e("div",Qe,[ze,r.value?(i(),a("div",Je,[e("input",{value:l.sala.name,class:"form-control",disabled:""},null,8,Pe)])):c((i(),a("select",{key:1,"onUpdate:modelValue":t[5]||(t[5]=s=>l.sala_id=s),class:w(["form-select",{"is-invalid":d(v).sala_id.$error&&b.value}]),onChange:oe,disabled:r.value},[We,(i(!0),a(p,null,g(K.value,s=>(i(),a("option",{key:s.value,value:s.value},h(s.label),9,Xe))),128))],42,He)),[[y,l.sala_id]]),d(v).sala_id.$error&&b.value?(i(),a("div",Ye," Campo obrigat\xF3rio ")):u("",!0)]),e("div",Ze,[es,c(e("select",{"onUpdate:modelValue":t[6]||(t[6]=s=>l.feeding_curve_id=s),class:w(["form-select",{"is-invalid":d(v).feeding_curve_id.$error&&b.value}]),onChange:t[7]||(t[7]=s=>G(l.feeding_curve_id))},[ss,(i(!0),a(p,null,g(E.value,s=>(i(),a("option",{key:s.value,value:s.value},h(s.label),9,ts))),128))],34),[[y,l.feeding_curve_id]]),d(v).feeding_curve_id.$error&&b.value?(i(),a("div",is," Campo obrigat\xF3rio ")):u("",!0)]),e("div",as,[ls,c(e("select",{"onUpdate:modelValue":t[8]||(t[8]=s=>l.initial_day=s),class:w(["form-select",{"is-invalid":d(v).initial_day.$error&&b.value}]),disabled:O.value.length===0},[ns,(i(!0),a(p,null,g(O.value,s=>(i(),a("option",{key:s,value:s}," Dia "+h(s),9,ds))),128))],10,os),[[y,l.initial_day]]),d(v).initial_day.$error&&b.value?(i(),a("div",cs," Selecione o dia inicial do lote ")):u("",!0)])]),e("div",null,[e("div",us,[rs,e("div",null,[r.value?(i(),a("button",{key:0,type:"button",class:"btn btn-success btn-sm",onClick:ve},[L(m,{name:"plus"}),J(" Novo Movimento ")])):u("",!0)])]),l.moviments.length>0?(i(),a("div",_s,[vs,(i(!0),a(p,null,g(l.moviments,(s,Q)=>(i(),a("div",{key:Q,class:"row g-2 align-items-start mb-2"},[e("div",ms,[c(e("select",{"onUpdate:modelValue":n=>s.moviment_kind_id=n,class:"form-select",disabled:!s.isNew},[ps,(i(!0),a(p,null,g(D.value,n=>(i(),a("option",{key:n.value,value:n.value},h(n.label),9,hs))),128))],8,bs),[[y,s.moviment_kind_id]])]),e("div",fs,[c(e("select",{"onUpdate:modelValue":n=>s.baia_origin_id=n,class:"form-select",disabled:!s.isNew},[gs,(i(!0),a(p,null,g(A.value,n=>(i(),a("option",{key:n.value,value:n.value},h(n.label),9,ks))),128))],8,ys),[[y,s.baia_origin_id]])]),e("div",ws,[c(e("select",{"onUpdate:modelValue":n=>s.baia_destination_id=n,class:"form-select",disabled:!s.isNew},[$s,(i(!0),a(p,null,g(A.value,n=>(i(),a("option",{key:n.value,value:n.value},h(n.label),9,As))),128))],8,Cs),[[y,s.baia_destination_id]])]),e("div",Vs,[c(e("input",{class:w([{"is-invalid":d(v).moviments.$each.$response.$data[Q].quantity.$error&&b.value},"form-control"]),"onUpdate:modelValue":n=>s.quantity=n,type:"number",min:"1",disabled:!s.isNew},null,10,Ns),[[N,s.quantity,void 0,{number:!0}]])]),e("div",Ss,[c(e("input",{"onUpdate:modelValue":n=>s.description=n,rows:"2",class:"form-control",placeholder:"Descri\xE7\xE3o opcional",disabled:!s.isNew},null,8,Ds),[[N,s.description]])]),s.id?(i(),a("div",Ms,[e("input",{value:d(Ce)(s.created_at),class:"form-control",disabled:""},null,8,Us)])):u("",!0)]))),128))])):u("",!0)]),e("button",{onClick:re,class:"btn btn-primary mb-4 btn-lg",disabled:q.value},[q.value?(i(),a("span",Rs)):u("",!0),J(" Salvar ")],8,qs),V.value?(i(),a("div",Bs,[e("div",Es,[e("div",Os,[e("div",Ts,[xs,e("button",{type:"button",class:"btn-close",onClick:t[9]||(t[9]=s=>V.value=!1)})]),e("div",Ls,[e("div",Fs,[Is,c(e("select",{"onUpdate:modelValue":t[10]||(t[10]=s=>_.moviment_kind_id=s),class:w(["form-select",{"is-invalid":d(k).moviment_kind_id.$error}]),onChange:me},[Ks,(i(!0),a(p,null,g(D.value,s=>(i(),a("option",{key:s.value,value:s.value},h(s.label),9,js))),128))],34),[[y,_.moviment_kind_id]]),d(k).moviment_kind_id.$error?(i(),a("div",Gs," Campo obrigat\xF3rio ")):u("",!0)]),["ENTRADA","TRANSFERENCIA"].includes(M.value)?(i(),a("div",Qs,[zs,c(e("select",{"onUpdate:modelValue":t[11]||(t[11]=s=>_.baia_origin_id=s),class:w(["form-select",{"is-invalid":d(k).baia_origin_id.$error}])},[Js,(i(!0),a(p,null,g(A.value,s=>(i(),a("option",{key:s.value,value:s.value},h(s.label)+" ("+h(s.qnt)+" animais) ",9,Ps))),128))],2),[[y,_.baia_origin_id]]),d(k).stall_origin_id.$error?(i(),a("div",Hs," Campo obrigat\xF3rio ")):u("",!0)])):u("",!0),["SAIDA","TRANSFERENCIA"].includes(M.value)?(i(),a("div",Ws,[Xs,c(e("select",{"onUpdate:modelValue":t[12]||(t[12]=s=>_.baia_destination_id=s),class:w(["form-select",{"is-invalid":d(k).baia_destination_id.$error}])},[Ys,(i(!0),a(p,null,g(A.value,s=>(i(),a("option",{key:s.value,value:s.value},h(s.label)+" ("+h(s.qnt)+" animais) ",9,Zs))),128))],2),[[y,_.baia_destination_id]]),d(k).baia_destination_id.$error?(i(),a("div",et," Campo obrigat\xF3rio ")):u("",!0)])):u("",!0),e("div",st,[tt,c(e("input",{"onUpdate:modelValue":t[13]||(t[13]=s=>_.quantity=s),type:"number",min:"1",class:w(["form-control",{"is-invalid":d(k).quantity.$error}])},null,2),[[N,_.quantity,void 0,{number:!0}]]),d(k).quantity.$error?(i(),a("div",it," Campo obrigat\xF3rio ")):u("",!0)]),e("div",at,[lt,c(e("textarea",{"onUpdate:modelValue":t[14]||(t[14]=s=>_.description=s),class:"form-control"},null,512),[[N,_.description]])])]),e("div",ot,[e("button",{class:"btn btn-secondary",onClick:t[15]||(t[15]=s=>V.value=!1)},"Cancelar"),e("button",{class:"btn btn-success",onClick:be},"Salvar Movimento")])])])])):u("",!0),V.value?(i(),a("div",nt)):u("",!0)]),_:1})])],64)}}};export{vt as default};
